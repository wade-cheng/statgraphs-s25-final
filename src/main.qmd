---
title: "Baseball Analysis"
format: html
output-file: "index.html"
authors:
# https://quarto.org/docs/journals/authors.html#author-schema
# if you want to be fancy with it
  - name: Elina Lee
  - name: Wade Cheng 
  - name: Jaihao Wu
  - name: Leo Yao
---

```{r, include=FALSE}
library(tidyverse)
library(viridis)
```


```{r, include=FALSE}
baseball <- read_csv("train.csv", col_types="iDfffcciiffffffiiiidddddf")
park_dim <- read_csv("park_dimensions.csv")
lockBinding("baseball", globalenv()) # make baseball immutable
```

## Introduction

Yap yap yap. Describe/contextualize the data.

Describe the main research questions of the project.

## Results

### Bearing

Ball bearing is correlated with player handedness.

```{r, echo=FALSE}
# mar
# A numerical vector of the form c(bottom, left, top, right) which gives the number of lines of margin to be specified on the four sides of the plot. The default is c(5, 4, 4, 2) + 0.1.
par(mfrow = c(1, 2), mar=c(6,1,4,1))
batter = table(baseball$bearing, baseball$is_batter_lefty)
dimnames(batter) <- list(
  c("left", "center", "right"),
  c("right \nhanded","left \nhanded")
) 

mosaicplot(
  batter, 
  shade=TRUE, 
  las=1,
  main="Batter handedness vs bearing"
  #ylab=c("test","test2","dsf")
)
# text( .2,.6, "TEMP GRAHHHHHHHH",col = "black",cex = 0.5) 
rasterImage(png::readPNG("media/Wii_batter_lefth.png"), xleft=0.4, ybottom=0, xright=0.6, ytop=0.4)
rasterImage(png::readPNG("media/Wii_batter_righth.png"), xleft=0.4, ybottom=0.5, xright=0.6, ytop=0.9)

# reverse bearing for better visualization (pitcher's pov is right center left)
rev_bearing = factor(baseball$bearing, levels=c("right", "center", "left"))
pitcher = table(rev_bearing, baseball$is_pitcher_lefty)
dimnames(pitcher) <- list(
  c("right", "center", "left"),
  c("right \nhanded","left \nhanded")
) 
mosaicplot(
  pitcher, 
  shade=TRUE, 
  las=1,
  main="Pitcher handedness vs bearing"
)
rasterImage(png::readPNG("media/Wii_pitcher_lefth.png"), xleft=0.3, ybottom=0.2, xright=0.6, ytop=0.5)
rasterImage(png::readPNG("media/Wii_pitcher_righth.png"), xleft=0.3, ybottom=0.7, xright=0.6, ytop=1)
```


### Inning

Inning affects pitching and batting gameplay.

### Launch angle

Home runs appear in a select portion of angles.

```{r, echo=FALSE}
pitch_data <- baseball |> 
  filter(!is.na(launch_angle))

home_run_medians <- pitch_data |>
  filter(is_home_run == 1) |>
  summarise(
    median_launch_angle = median(launch_angle, na.rm = TRUE),
    median_pitch_speed = median(pitch_mph, na.rm = TRUE)
  )

ggplot(pitch_data, aes(x = launch_angle, y = pitch_mph, color = as.factor(is_home_run))) +
  geom_point(alpha = 0.4, size = 1.5) +
  scale_color_manual(values = c("0" = "gray", "1" = "red"), 
                     labels = c("No", "Yes")) +
  geom_vline(xintercept = home_run_medians$median_launch_angle, 
             color = "orange", linetype = "solid") +
  geom_hline(yintercept = home_run_medians$median_pitch_speed, 
             color = "blue", linetype = "solid") + 
  annotate("text", 
           x = home_run_medians$median_launch_angle + 2,
           y = max(pitch_data$pitch_mph),
           label = paste("Median Launch Angle:", round(home_run_medians$median_launch_angle, 2)), 
           color = "orange", hjust = 0) + 
  annotate("text", 
           x = min(pitch_data$launch_angle, na.rm = TRUE) + 15,
           y = home_run_medians$median_pitch_speed + 1,
           label = paste("Median Pitch Speed:", round(home_run_medians$median_pitch_speed, 2)), 
           color = "blue", hjust = 0) +
  annotate("text", x = 50, y = 87, label = "Linear Trend", color = "black", hjust = 0) +
  geom_smooth(method = "lm", se = FALSE, color = "black", size = 1.1) +
  labs(
    title = "Launch Angle vs. Pitch Speed by Home Run with Median Line",
    x = "Launch Angle (degrees)",
    y = "Pitch Speed (mph)",
    color = "Is Home Run"
  ) +
  theme_minimal() +
  theme(legend.position = "top")
```



### Hit location

Home runs are consistently hit in specific locations.

```{r, echo=FALSE}
baseball |>
  ggplot(aes(x = plate_x, y = plate_z)) +
  stat_density2d(aes(fill = after_stat(level)), geom = "polygon") + 
  facet_grid(. ~ fct_recode(factor(is_home_run), "Home Run" = "1", "Not Home Run" = "0")) + 
  labs(title = "Contour Plot of Plate Positions", x = "plate_x (feet)", y = "plate_z (feet)", 
       caption = "Note: red line is middle of plate") +
  geom_vline(xintercept = 0, color = "red", size = 1) + 
  scale_fill_viridis(name = "Density Level") + 
  theme_bw()
```

Graphic 2: analyzing lefty with

```{r}
park_dim$park <- as.factor(park_dim$park)
altered_bb <- full_join(baseball, park_dim, by = "park")
altered_bb <- altered_bb |>
  mutate(sp_ratio = launch_speed/pitch_mph)

bb_data_lefty <- altered_bb |>
  filter(is_batter_lefty == 1) |>
  select(- is_batter_lefty)
bb_data_lefty <- na.omit(bb_data_lefty)

bb_data_righty <- altered_bb |>
  filter(is_batter_lefty == 0) |>
  select(- is_batter_lefty)
bb_data_righty <- na.omit(bb_data_righty)

altered_bb.rm <- na.omit(altered_bb)

l_cor <- round(cor(bb_data_lefty$plate_z, bb_data_lefty$sp_ratio), 5)
r_cor <- round(cor(bb_data_righty$plate_z, bb_data_righty$sp_ratio), 5)
t_cor <- round(cor(altered_bb.rm$plate_z, altered_bb.rm$sp_ratio), 5)

labels <- data.frame(
  is_batter_lefty = c("0", "1"),  # MUST match the original raw values
  plate_z = c(4, 4),              # x-coordinate for label
  sp_ratio = c(1.5, 1.5),         # y-coordinate for label
  label = c(paste("r =", r_cor), paste("r =", l_cor))
)

# Now fix the plot:
altered_bb |> 
  ggplot(aes(x = plate_z, y = sp_ratio)) + 
  geom_point(alpha = 0.05) + 
  facet_grid(. ~ fct_recode(is_batter_lefty, "Righty" = "0", "Lefty" = "1")) +
  geom_smooth(method = "lm", se = FALSE, color = "red") + 
  geom_text(
    data = labels,
    mapping = aes(x = plate_z, y = sp_ratio, label = label),  # <- use variable names, not constants
    inherit.aes = FALSE,
    size = 3.5
  ) +
  theme_bw() + 
  labs(title = "Scatterplots of Pitch Height vs. Speed Ratio by Batter Handedness", x = "plate_z (feet)", y = "Speed Ratio", caption = "Speed Ratio is Launch Speed / Pitch Speed")
```




## Discussion

Yap about main conclusions.

### Future Work

Yap about potential directions for future work.

## Appendix

![Jaihao is Kermit](./media/kermit.png)