---
title: "Baseball Analysis"
format: html
output-file: "index.html"
bibliography: sources.bib
authors:
# https://quarto.org/docs/journals/authors.html#author-schema
# if you want to be fancy with it
  - name: Elina Lee
  - name: Wade Cheng 
  - name: Jaihao Wu
  - name: Leo Yao
# these can be enabled to stop running code chunks, which is helpful if you just
# want to test out content without needing to compile everything every re-render
# execute:
#   eval: false
---

```{r, include=FALSE}
library(tidyverse)
library(viridis)
```


```{r, include=FALSE}
baseball <- read_csv("train.csv", col_types="iDfffcciiffffffiiiidddddf")
lockBinding("baseball", globalenv()) # make baseball immutable
```

## Introduction

Baseball, the great American pastime, makes over ten billion dollars year over 
year [@cohen_2024_mlb], draws millions to stadiums across the nation 
[@attendence_2023], and is played recreationally at parks and schools every
single fortnite, or something. After too many times malding at the TV over
terrible plays or inscrutable ball trajectories, we decided it would be 
interesting to pick apart some data to reveal more objective insights into this
popular game.

Our dataset [@jcraggy_2020_baseball] comes from a Kaggle model-creating 
competition to predict home runs. It has 46,244 recordings that represent each
batted ball from the 2020 MLB season (which was abbreviated due to COVID---60
games were played instead of the usual 162). The dataset did include postseason
games. 

Each recording had twenty-five variables. We analyzed the subset below:

**TODO: bold variables you use!**
**This will help us remove items we didn't use, later**

- bip_id: unique identifier of ball in play
- game_date: date of game (YYYY-MM-DD)
- home_team: home team abbreviation
- away_team: away team abbreviation
- batter_team: batter's team abbreviation
- batter_name: batter's name
- pitcher_name: pitcher's name
- batter_id: batter's unique identifier
- pitcher_id: pitcher's unique identifier
- **is_batter_lefty: binary encoding of left-handed batters**
- **is_pitcher_lefty: binary encoding of left-handed pitchers**
- bb_type: batted ball type classification
- **bearing: horizontal direction classification of ball leaving the bat (i.e. 'left' ball is traveling to the left side of the field)**
- pitch_name: name of pitch type thrown
- park: unique identifier of park venue
- inning: inning number within game
- outs_when_up: current number of outs
- balls: current number of balls
- strikes: current number of strikes
- plate_x: ball position left(-) or right(+) of center plate (feet)
- plate_z: ball position above home plate (feet)
- pitch_mph: speed of pitched ball (miles per hour)
- launch_speed: speed of ball leaving the bat (miles per hour)
- launch_angle: vertical angle of ball leaving the bat (degrees relative to horizontal)
- is_home_run: binary encoding of home runs

<!-- NOTE: feel free to change "special focus" if you change your main variable -->

With these variables, we aimed to investigate anything that might help a team
win a game of baseball, with special focus on ball bearing, inning number, launch
angle, and hit location.

## Results

### Bearing

Ball bearing is correlated with player handedness.

```{r, echo=FALSE}
# mar
# A numerical vector of the form c(bottom, left, top, right) which gives the number of lines of margin to be specified on the four sides of the plot. The default is c(5, 4, 4, 2) + 0.1.
par(mfrow = c(1, 2), mar=c(6,1,4,1))
batter = table(baseball$bearing, baseball$is_batter_lefty)
dimnames(batter) <- list(
  c("left", "center", "right"),
  c("right \nhanded","left \nhanded")
) 

mosaicplot(
  batter, 
  shade=TRUE, 
  las=1,
  main="Batter handedness vs bearing"
  #ylab=c("test","test2","dsf")
)
# text( .2,.6, "TEMP GRAHHHHHHHH",col = "black",cex = 0.5) 
rasterImage(png::readPNG("media/Wii_batter_lefth.png"), xleft=0.4, ybottom=0, xright=0.6, ytop=0.4)
rasterImage(png::readPNG("media/Wii_batter_righth.png"), xleft=0.4, ybottom=0.5, xright=0.6, ytop=0.9)

# reverse bearing for better visualization (pitcher's pov is right center left)
rev_bearing = factor(baseball$bearing, levels=c("right", "center", "left"))
pitcher = table(rev_bearing, baseball$is_pitcher_lefty)
dimnames(pitcher) <- list(
  c("right", "center", "left"),
  c("right \nhanded","left \nhanded")
) 
mosaicplot(
  pitcher, 
  shade=TRUE, 
  las=1,
  main="Pitcher handedness vs bearing"
)
rasterImage(png::readPNG("media/Wii_pitcher_lefth.png"), xleft=0.3, ybottom=0.2, xright=0.6, ytop=0.5)
rasterImage(png::readPNG("media/Wii_pitcher_righth.png"), xleft=0.3, ybottom=0.7, xright=0.6, ytop=1)
```


### Inning

Inning affects pitching and batting gameplay.

### Launch angle

Home runs appear in a select portion of angles.

```{r, echo=FALSE}
pitch_data <- baseball |> 
  filter(!is.na(launch_angle))

home_run_medians <- pitch_data |>
  filter(is_home_run == 1) |>
  summarise(
    median_launch_angle = median(launch_angle, na.rm = TRUE),
    median_pitch_speed = median(pitch_mph, na.rm = TRUE)
  )

ggplot(pitch_data, aes(x = launch_angle, y = pitch_mph, color = as.factor(is_home_run))) +
  geom_point(alpha = 0.4, size = 1.5) +
  scale_color_manual(values = c("0" = "gray", "1" = "red"), 
                     labels = c("No", "Yes")) +
  geom_vline(xintercept = home_run_medians$median_launch_angle, 
             color = "orange", linetype = "solid") +
  geom_hline(yintercept = home_run_medians$median_pitch_speed, 
             color = "blue", linetype = "solid") + 
  annotate("text", 
           x = home_run_medians$median_launch_angle + 2,
           y = max(pitch_data$pitch_mph),
           label = paste("Median Launch Angle:", round(home_run_medians$median_launch_angle, 2)), 
           color = "orange", hjust = 0) + 
  annotate("text", 
           x = min(pitch_data$launch_angle, na.rm = TRUE) + 15,
           y = home_run_medians$median_pitch_speed + 1,
           label = paste("Median Pitch Speed:", round(home_run_medians$median_pitch_speed, 2)), 
           color = "blue", hjust = 0) +
  annotate("text", x = 50, y = 87, label = "Linear Trend", color = "black", hjust = 0) +
  geom_smooth(method = "lm", se = FALSE, color = "black", size = 1.1) +
  labs(
    title = "Launch Angle vs. Pitch Speed by Home Run with Median Line",
    x = "Launch Angle (degrees)",
    y = "Pitch Speed (mph)",
    color = "Is Home Run"
  ) +
  theme_minimal() +
  theme(legend.position = "top")
```



### Hit location

Home runs are consistently hit in specific locations.

```{r, echo=FALSE}
baseball |>
  ggplot(aes(x = plate_x, y = plate_z)) +
  stat_density2d(aes(fill = after_stat(level)), geom = "polygon") + 
  facet_grid(. ~ fct_recode(factor(is_home_run), "Home Run" = "1", "Not Home Run" = "0")) + 
  labs(title = "Contour Plot of Plate Positions", x = "plate_x (feet)", y = "plate_z (feet)", 
       caption = "Note: red line is middle of plate") +
  geom_vline(xintercept = 0, color = "red", size = 1) + 
  scale_fill_viridis(name = "Density Level") + 
  theme_bw()
    
```




## Discussion

Yap about main conclusions.

### Future Work

Yap about potential directions for future work.

## Appendix

![Jaihao is Kermit](./media/kermit.png)